# macOS 上配置 MASM 汇编开发环境

## 项目背景

在 macOS (Apple Silicon M1 Pro) 上搭建 16/32 位 x86 汇编开发环境，使用 MASM (Microsoft Macro Assembler) 工具链。

**系统环境**：
- 操作系统：macOS (Darwin 24.6.0)
- 芯片架构：ARM64 (Apple M1 Pro)
- Wine 版本：wine-10.0

---

## 问题 1：汇编时找不到 include 文件

### 错误信息

```
asm/study01.asm(2) : fatal error A1000: cannot open file : io16.inc
```

### 问题分析

- `io16.inc` 文件在项目根目录
- `study01.asm` 在 `asm/` 子目录
- 汇编器从当前目录查找 include 文件，找不到

### 解决方案

**方案 1**：修改 include 路径
```asm
include ../io16.inc  ; 使用相对路径
```

**方案 2**：复制文件到子目录
```bash
cp io16.inc asm/
```

**方案 3**：汇编时指定 include 路径
```bash
ml /I.. /c study01.asm
```

---

## 问题 2：不了解汇编程序的编译链接流程

### 学习内容

**16 位 DOS 程序流程**：
```bash
# 1. 汇编（.asm → .obj）
wine bin/ML.EXE /c /Fl study01.asm

# 2. 链接（.obj → .exe）
wine bin/LINK16.EXE study01.obj,,,io16.lib;

# 3. 运行
wine study01.exe
```

**关键参数**：
- `/c` - 只汇编不链接
- `/Fl` - 生成列表文件
- `io16.lib` - I/O 函数库（提供 `dispmsg`、`exit` 等函数）

---

## 问题 3：Wine 无法运行 16 位 DOS 程序

### 错误信息

```
wine: failed to open "krnl386.exe16"
err:module:loader_init Initializing dlls failed, status c0000005
```

### 问题分析

- Wine 在 macOS (特别是 Apple Silicon) 上不支持 16 位程序
- `winevdm.exe` 和 `krnl386.exe16` 初始化失败

### 尝试的方案

**方案 1**：使用 DOSBox-X
```bash
brew install dosbox-x
dosbox-x -conf dosbox.conf
```

**结果**：遇到 `Failed to get the current working directory` 错误，DOSBox-X 在当前环境下不稳定。

**方案 2**：转向 32 位程序（最终采用）

---

## 问题 4：32 位程序的编译链接

### 学习内容

**32 位 Windows 程序流程**：
```bash
# 1. 汇编（生成 COFF 格式）
wine bin/ML.EXE /c /coff /Fl test01.asm

# 2. 链接
wine bin/LINK32.EXE /subsystem:console test01.obj io32.lib

# 3. 运行
wine test01.exe
```

**关键差异**：
- 使用 `/coff` 参数（32 位需要 COFF 格式）
- 使用 `LINK32.EXE` 而不是 `LINK16.EXE`
- 使用 `io32.lib` 而不是 `io16.lib`

---

## 问题 5：Wine 缺少 DLL（错误 c0000135）

### 错误信息

```
wine: failed to open "bin/ML.EXE": c0000135
```

### 问题分析

- 错误代码 `c0000135` = `STATUS_DLL_NOT_FOUND`
- ARM64 版本的 wine 对 32 位程序支持有限
- 需要 x86_64 版本的 wine

### 解决方案

**使用 Rosetta 2 运行 x86_64 版本的 wine**：

```bash
# 检查 wine 架构
file /opt/homebrew/bin/wine
# 输出：Mach-O 64-bit executable x86_64

# 通过 Rosetta 运行
arch -x86_64 wine bin/ML.EXE /c /coff /Fl test01.asm
arch -x86_64 wine bin/LINK32.EXE /subsystem:console test01.obj io32.lib
arch -x86_64 wine test01.exe
```

**关键点**：
- `arch -x86_64` 前缀让命令通过 Rosetta 2 运行
- Rosetta 2 将 x86_64 指令转换为 ARM64

---

## 问题 6：批处理文件的使用

### 需求

在 Windows 虚拟机中的工作流程：
1. 运行 `WIN32.bat` 设置环境
2. 输入 `make32 test01` 编译
3. 输入 `test01.exe` 运行

### 解决方案

**创建交互式环境脚本** (`masm32.sh`)：

```bash
#!/bin/bash
echo "启动 MASM 32位开发环境..."
arch -x86_64 wine cmd /k "cd /d Z:\Volumes\study\MASM && set PATH=Z:\Volumes\study\MASM;Z:\Volumes\study\MASM\bin;%PATH%"
```

**使用方法**：
```bash
# 1. 启动环境
./masm32.sh

# 2. 在 wine 命令行中工作
make32 test01
test01.exe

# 3. 退出
exit
```

**关键参数**：
- `/k` - 执行命令后保持命令行打开（而不是 `/c` 执行后退出）
- `set PATH=...` - 配置环境变量

---

## 问题 7：子目录文件的路径问题

### 错误信息

```
LINK32 : fatal error LNK1181: cannot open input file "asm/study01.obj"
```

### 问题分析

- 从根目录运行 `make32 asm/study01`
- 汇编器生成 `study01.obj` 在根目录
- 链接器查找 `asm/study01.obj`
- 路径不匹配

### 解决方案

**方案 1**：在 asm 目录中工作（推荐）
```bash
cd asm
make32 study01
study01.exe
```

**方案 2**：复制库文件到 asm 目录
```bash
cp io32.inc io32.lib asm/
```

然后修改 `asm/study01.asm`：
```asm
include io32.inc  ; 去掉 ../
```

---

## 问题 8：IDE 文件过滤

### 需求

隐藏不需要的文件（.bat、.lib、.obj 等），但文件实际存在。

### 解决方案

**VS Code 配置** (`.vscode/settings.json`)：

```json
{
  "files.exclude": {
    "**/*.bat": true,
    "**/*.lib": true,
    "**/*.obj": true,
    "**/*.exe": true,
    "**/*.lst": true,
    "**/bin": true,
    "**/HELP": true,
    "**/progs": true
  }
}
```

---

## 最终工作流程

### 方式 1：交互式环境（推荐）

```bash
# 1. 启动 MASM 环境
./masm32.sh

# 2. 在 wine 命令行中
cd asm
make32 study01
study01.exe

# 3. 编译其他程序
make32 mycode
mycode.exe

# 4. 退出
exit
```

### 方式 2：一条命令

```bash
arch -x86_64 wine cmd /c "cd /d Z:\Volumes\study\MASM\asm && make32 study01 && study01.exe"
```

---

## 参考资料

### 查阅的文档

1. **Wine 文档**
   - Wine 在 macOS 上的 32 位支持
   - Wine 命令行参数（`/c` vs `/k`）

2. **MASM 文档**
   - ML.EXE 参数：`/c`, `/coff`, `/Fl`, `/I`
   - LINK32.EXE 参数：`/subsystem:console`

3. **批处理文件**
   - 项目自带的 `make32.bat` 和 `WIN32.bat`
   - 学习了批处理的基本语法

### 关键知识点

1. **16 位 vs 32 位**
   - 16 位：DOS 程序，需要 DOSBox
   - 32 位：Windows 程序，wine 支持更好

2. **Wine 路径映射**
   - Unix 路径：`/Volumes/study/MASM`
   - Wine 路径：`Z:\Volumes\study\MASM`

3. **Rosetta 2**
   - 让 ARM64 Mac 运行 x86_64 程序
   - 使用 `arch -x86_64` 前缀

---

## 常见问题

### Q1: 为什么不用 DOSBox？

**A**: DOSBox 主要支持 16 位 DOS 程序，对 32 位 Windows 程序支持有限。而且在当前环境下遇到了工作目录问题。

### Q2: 为什么要用 Rosetta？

**A**: Apple Silicon (ARM64) 原生的 wine 对 32 位 x86 程序支持不完整。通过 Rosetta 运行 x86_64 版本的 wine，可以获得更好的兼容性。

### Q3: 可以用原生 macOS 工具吗？

**A**: 可以。可以使用 NASM + ld 编写和编译汇编程序，但需要重写代码（MASM 和 NASM 语法不同）。

---

## 总结

通过这次配置，学到了：

1. **跨平台开发的复杂性**
   - 不同架构（ARM64 vs x86）
   - 不同操作系统（macOS vs Windows）
   - 不同位数（16 位 vs 32 位）

2. **Wine 的使用**
   - 命令行参数
   - 路径映射
   - 批处理文件执行

3. **汇编开发流程**
   - 汇编 → 链接 → 运行
   - include 文件和库文件的管理
   - 不同位数程序的差异

4. **问题解决思路**
   - 从错误信息入手
   - 理解工具链的工作原理
   - 尝试多种方案
   - 选择最简单可靠的方案

**最重要的经验**：遇到复杂问题时，先理解每个工具的作用和限制，再寻找合适的解决方案。
